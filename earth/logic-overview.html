<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>전체 로직 설명서 — 지구 시뮬레이션 프로젝트</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#060c1a;color:#c8cce0;font-family:'Segoe UI',system-ui,sans-serif;line-height:1.75}
.container{max-width:1200px;margin:0 auto;padding:20px 24px 60px}
h1{text-align:center;padding:24px;font-size:1.5em;border-bottom:1px solid #1a2a4a;margin-bottom:8px}
h1 small{display:block;color:#5a8abf;font-size:.52em;font-weight:normal;margin-top:4px}
h2{color:#5af;font-size:1.12em;margin:32px 0 10px;padding:8px 14px;background:#0c1530;border-left:3px solid #5af;border-radius:0 6px 6px 0}
h3{color:#4ecdc4;font-size:.94em;margin:20px 0 8px;padding-left:4px}
h4{color:#ffe66d;font-size:.88em;margin:14px 0 6px}
p{font-size:.86em;color:#8899bb;margin:4px 0 10px;text-align:justify}
b{color:#cdd}
.note{background:#0c1530;border:1px solid #152040;border-radius:6px;padding:10px 14px;font-size:.82em;margin:10px 0 14px}

code{background:#0e1530;border:1px solid #1a2a4a;border-radius:3px;padding:1px 5px;font-family:'Courier New',monospace;font-size:.9em;color:#5af}
pre{background:#0a0e20;border:1px solid #1a2a4a;border-radius:8px;padding:14px 18px;font-family:'Courier New',monospace;font-size:.8em;color:#a8b8d8;overflow-x:auto;margin:8px 0 14px;line-height:1.5}
pre b{color:#5af}
pre em{color:#4ecdc4;font-style:normal}
pre .cm{color:#4a5a7a}
pre .kw{color:#ff8866}
pre .fn{color:#ffe66d}
pre .num{color:#a29bfe}

.diagram{background:#080e20;border:1px solid #152040;border-radius:8px;padding:18px;font-family:'Courier New',monospace;font-size:.78em;color:#6a8aaa;overflow-x:auto;margin:10px 0 16px;line-height:1.6;white-space:pre}
.diagram b{color:#5af}
.diagram em{color:#4ecdc4;font-style:normal}
.diagram .h{color:#ffe66d}
.diagram .r{color:#ff6b6b}

table{width:100%;border-collapse:collapse;margin:8px 0 16px;font-size:.82em}
th{background:#0e1835;color:#5a9acf;padding:6px 8px;text-align:center;border:1px solid #1a2a4a;font-weight:600}
td{padding:5px 8px;border:1px solid #152040;text-align:center}
tr:nth-child(even) td{background:#0a1225}
.left{text-align:left}
.val{font-family:'Courier New',monospace;color:#fff;font-weight:600}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:900px){.grid2{grid-template-columns:1fr}}
.card{background:#0a1225;border:1px solid #152040;border-radius:8px;padding:14px}
.card h4{margin-top:0}

.toc{background:#0c1530;border:1px solid #152040;border-radius:8px;padding:16px 22px;margin:14px 0 24px}
.toc h3{color:#5af;margin:0 0 8px}
.toc ol{padding-left:22px;margin:0}
.toc li{margin:4px 0;font-size:.88em}
.toc a{color:#5af;text-decoration:none}
.toc a:hover{text-decoration:underline}
.toc ol ol{margin-top:4px}

a{color:#5af}
.back{position:fixed;bottom:20px;right:20px;background:#1a3060;border:1px solid #2a4a7a;color:#5af;padding:8px 16px;border-radius:6px;text-decoration:none;font-size:.85em;z-index:99}
.back:hover{background:#2a4a8a;color:#fff}
</style>
</head>
<body>
<a href="index.html" class="back">← 인덱스</a>
<div class="container">

<h1>전체 로직 설명서
<small>지구 시뮬레이션 프로젝트 — 과학 원리 · 수학 모델 · 알고리즘 · 데이터 흐름</small>
</h1>

<div class="toc">
<h3>목차</h3>
<ol>
  <li><a href="#ch1">프로젝트 전체 아키텍처</a></li>
  <li><a href="#ch2">Layer 1: 궤도 역학 계산 엔진</a>
    <ol><li>이심률 모델</li><li>황도경사각 모델</li><li>세차운동 모델</li><li>일사량 모델</li></ol>
  </li>
  <li><a href="#ch3">Layer 2: 대기순환 모델</a>
    <ol><li>3셀 순환 구조</li><li>바람 벡터 계산</li><li>ITCZ 동역학</li><li>몬순·제트기류</li></ol>
  </li>
  <li><a href="#ch4">Layer 3: 지구 물리 데이터</a>
    <ol><li>대륙 폴리곤 시스템</li><li>육지 마스크 생성</li><li>지형·바이옴 색상</li></ol>
  </li>
  <li><a href="#ch5">Layer 4: 렌더링 엔진</a>
    <ol><li>3D 구면 투영</li><li>공전 궤도 시각화</li><li>바람 입자 시스템</li><li>시계열 차트</li></ol>
  </li>
  <li><a href="#ch6">Layer 5: 분석 및 비교 엔진</a></li>
  <li><a href="#ch7">모듈 간 데이터 흐름</a></li>
  <li><a href="#ch8">핵심 알고리즘 상세 해설</a></li>
  <li><a href="#ch9">과학적 근거 및 한계</a></li>
</ol>
</div>

<!-- ============================================ -->
<h2 id="ch1">1. 프로젝트 전체 아키텍처</h2>
<!-- ============================================ -->

<h3>1-1. 5계층 구조</h3>

<div class="diagram">
┌─────────────────────────────────────────────────────────────┐
│                    <b>사용자 인터페이스</b>                          │
│   시간 슬라이더 · 속도 조절 · 파라미터 조정 · 마우스 인터랙션     │
└────────────────────────┬────────────────────────────────────┘
                         │ 사용자 입력 (시간 t, 속도, 파라미터)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              <b>Layer 5: 분석·비교 엔진</b>                       │
│   과거 데이터 비교 · 추세 계산 · 간빙기 순위 · 종합 판단        │
└────────────────────────┬────────────────────────────────────┘
                         │ 분석 결과, 표·차트 데이터
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              <b>Layer 4: 렌더링 엔진</b>                          │
│   3D 구면투영 · 궤도 시각화 · 입자 시스템 · 차트 그리기         │
└────────────────────────┬────────────────────────────────────┘
                         │ 좌표 변환, 색상 매핑
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              <b>Layer 3: 지구 물리 데이터</b>                      │
│   대륙 폴리곤 · 육지 마스크 · 바이옴 색상 · 지형 정보           │
└────────────────────────┬────────────────────────────────────┘
                         │ isLand(lat,lon), 색상값
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              <b>Layer 2: 대기순환 모델</b>                         │
│   3셀 순환 · ITCZ · 무역풍 · 편서풍 · 몬순 · 제트기류         │
│   getWind(lat, lon, day, obliquity) → {u, v}                │
└────────────────────────┬────────────────────────────────────┘
                         │ 바람 벡터 (u, v), ITCZ 위도
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              <b>Layer 1: 궤도 역학 계산</b>                        │
│   Berger 1978 푸리에 급수                                     │
│   calcEcc(t) · calcObl(t) · calcPrec(t) · calcInsol(t)     │
└─────────────────────────────────────────────────────────────┘
                         │ e(t), ε(t), P(t), Q(t)
                         ▼
                    <em>[시간 t (kyr)]</em>
</div>

<h3>1-2. 파일-계층 매핑</h3>
<table>
<tr>
  <th>파일</th>
  <th>Layer 1<br>궤도 계산</th>
  <th>Layer 2<br>대기순환</th>
  <th>Layer 3<br>물리 데이터</th>
  <th>Layer 4<br>렌더링</th>
  <th>Layer 5<br>분석</th>
</tr>
<tr>
  <td class="left val">milankovitch.html</td>
  <td class="val">●</td><td>—</td><td>—</td><td class="val">●</td><td>—</td>
</tr>
<tr>
  <td class="left val">earth-simulation.html</td>
  <td>△ (파라미터)</td><td class="val">●</td><td class="val">●</td><td class="val">●</td><td>—</td>
</tr>
<tr>
  <td class="left val">reference.html</td>
  <td>△ (수식)</td><td>△ (수치)</td><td>—</td><td>△ (차트1개)</td><td class="val">●</td>
</tr>
<tr>
  <td class="left val">trend-analysis.html</td>
  <td class="val">●</td><td>△ (추세표)</td><td>—</td><td class="val">●</td><td class="val">●</td>
</tr>
</table>
<p>● = 핵심 사용, △ = 부분 참조</p>

<!-- ============================================ -->
<h2 id="ch2">2. Layer 1: 궤도 역학 계산 엔진</h2>
<!-- ============================================ -->

<p>밀란코비치 궤도 요소를 시간의 함수로 계산하는 핵심 엔진입니다. Berger (1978)의 해석적 풀이를 간략화한 <b>푸리에 급수</b>를 사용합니다.</p>

<h3>2-1. 이심률 (Eccentricity) 모델</h3>

<h4>과학적 원리</h4>
<p>지구 궤도의 이심률은 주로 목성과 토성의 중력 섭동에 의해 변합니다. 완전한 계산에는 N-body 시뮬레이션이 필요하지만, 장주기 변동은 준주기적이어서 푸리에 급수로 근사할 수 있습니다.</p>

<h4>수학 모델</h4>
<pre>
<b>e(t)</b> = e₀ + Σᵢ Aᵢ · cos(2π·t/Tᵢ + φᵢ)

<em>사용된 항:</em>
  e₀ = <span class="num">0.028011</span>          <span class="cm">// 평균 이심률</span>

  항 1: A=<span class="num">0.010738</span>, T=<span class="num">413.0</span> kyr, φ=<span class="num">3.135</span>   <span class="cm">// 413kyr 장주기 (가장 큰 진폭)</span>
  항 2: A=<span class="num">0.008263</span>, T=<span class="num">100.0</span> kyr, φ=<span class="num">0.208</span>   <span class="cm">// 100kyr 빙하기 주기</span>
  항 3: A=<span class="num">0.004095</span>, T=<span class="num"> 95.0</span> kyr, φ=<span class="num">1.950</span>   <span class="cm">// 95kyr (100kyr과 간섭 → 맥놀이)</span>
  항 4: A=<span class="num">0.003633</span>, T=<span class="num">123.8</span> kyr, φ=<span class="num">4.885</span>   <span class="cm">// 보조 항</span>
  항 5: A=<span class="num">0.002425</span>, T=<span class="num">131.0</span> kyr, φ=<span class="num">2.105</span>   <span class="cm">// 보조 항</span>
</pre>

<h4>왜 이 항들인가?</h4>
<div class="note">
<b>413kyr 항:</b> 목성-토성 세속 공명(g₂-g₅)의 근본 주기. 이심률 변동의 <b>포락선</b>을 결정합니다. 이심률이 높을 때 100kyr 빙하주기가 활성화됩니다.<br><br>
<b>100kyr + 95kyr 항:</b> 두 항의 간섭으로 실제 관측되는 ~100kyr 빙하기 주기와 일치하는 맥놀이(beat) 패턴을 생성합니다. 100kyr과 95kyr의 맥놀이 주기 = 1/(1/95 - 1/100) ≈ 1,900kyr.
</div>

<h4>코드 구현</h4>
<pre>
<span class="kw">function</span> <span class="fn">calcEccentricity</span>(tKyr) {
  <span class="kw">return</span> <span class="num">0.028011</span>
    + <span class="num">0.010738</span> * Math.cos(<span class="num">2</span>*Math.PI * tKyr/<span class="num">413.0</span> + <span class="num">3.135</span>)
    + <span class="num">0.008263</span> * Math.cos(<span class="num">2</span>*Math.PI * tKyr/<span class="num">100.0</span> + <span class="num">0.208</span>)
    + <span class="num">0.004095</span> * Math.cos(<span class="num">2</span>*Math.PI * tKyr/<span class="num">95.0</span>  + <span class="num">1.950</span>)
    + <span class="num">0.003633</span> * Math.cos(<span class="num">2</span>*Math.PI * tKyr/<span class="num">123.8</span> + <span class="num">4.885</span>)
    + <span class="num">0.002425</span> * Math.cos(<span class="num">2</span>*Math.PI * tKyr/<span class="num">131.0</span> + <span class="num">2.105</span>);
}
</pre>

<h3>2-2. 황도경사각 (Obliquity) 모델</h3>

<h4>과학적 원리</h4>
<p>자전축 기울기는 달과 태양의 조석력, 그리고 다른 행성들의 중력 섭동에 의해 변합니다. 달이 없었다면 기울기 변동은 현재의 2.4° 범위가 아니라 0°~85°까지 혼돈적으로 변했을 것입니다.</p>

<h4>수학 모델</h4>
<pre>
<b>ε(t)</b> = ε₀ + Σᵢ Bᵢ · cos(2π·t/Tᵢ + ψᵢ)

  ε₀ = <span class="num">23.320556°</span>        <span class="cm">// 평균 황도경사각</span>

  항 1: B=<span class="num">1.000°</span>, T=<span class="num">41.0</span> kyr, ψ=<span class="num">2.399</span>   <span class="cm">// 주 주기 (지배적)</span>
  항 2: B=<span class="num">0.430°</span>, T=<span class="num">39.73</span> kyr, ψ=<span class="num">3.810</span>  <span class="cm">// 보조 (41kyr과 간섭)</span>
  항 3: B=<span class="num">0.280°</span>, T=<span class="num">53.6</span> kyr, ψ=<span class="num">1.280</span>   <span class="cm">// 장주기 변조</span>
  항 4: B=<span class="num">0.175°</span>, T=<span class="num">40.3</span> kyr, ψ=<span class="num">5.200</span>   <span class="cm">// 미세 조정</span>
</pre>

<div class="note">
<b>41kyr 주기의 기원:</b> 지구 자전축의 경사 진동은 달의 궤도면 세차와 행성 궤도면 세차의 결합에서 발생합니다. 41kyr = 지구 자전축 세차(~26kyr)와 궤도면 세차(~70kyr)의 조합: 1/(1/26 - 1/70) ≈ 41kyr.
</div>

<h3>2-3. 기후적 세차 지수 (Climatic Precession Index)</h3>

<h4>과학적 원리</h4>
<p>세차운동 자체는 ~26,000년 주기로 자전축이 원뿔을 그리는 것이지만, 기후에 영향을 미치는 것은 <b>근일점 경도(ω̃)와 이심률의 곱</b>인 <code>e·sin(ω̃)</code>입니다. 이것이 어느 반구의 어느 계절에 태양이 더 가까운지를 결정합니다.</p>

<h4>수학 모델</h4>
<pre>
<b>P(t)</b> = e(t) · sin(ω̃(t))

ω̃(t) = 2π·t/<span class="num">21.7</span> + <span class="num">1.2</span>
      + <span class="num">0.6</span>·sin(2π·t/<span class="num">23.7</span> + <span class="num">0.5</span>)   <span class="cm">// 23kyr 성분</span>
      + <span class="num">0.3</span>·sin(2π·t/<span class="num">18.97</span> + <span class="num">2.1</span>)  <span class="cm">// 19kyr 성분</span>
</pre>

<div class="note">
<b>핵심 포인트:</b> 세차 지수의 <b>진폭은 이심률에 비례</b>합니다. 따라서 이심률이 작은 현재(0.017)에는 세차의 기후 효과가 약하고, 이심률이 컸던 125kyr 전(0.040)에는 강했습니다. 이것이 이심률과 세차가 결합하여 빙하기 주기를 만드는 메커니즘입니다.
</div>

<h3>2-4. 일사량 (Insolation) 모델</h3>

<h4>과학적 원리</h4>
<p>65°N 하지 일사량은 밀란코비치 이론에서 빙하기 발생의 핵심 지표입니다. 이 값이 임계치 이하로 내려가면 여름에 전년도 눈이 녹지 않아 빙하가 축적됩니다.</p>

<h4>수학 모델</h4>
<pre>
<b>Q(t)</b> = Q₀ + (∂Q/∂ε)·(ε(t) - ε̄) + (∂Q/∂P)·P(t)

  Q₀ = <span class="num">475.0</span> W/m²        <span class="cm">// 기준 일사량</span>
  ∂Q/∂ε = <span class="num">+8.0</span> W/m²/°     <span class="cm">// 경사각 민감도</span>
  ∂Q/∂P = <span class="num">-70.0</span> W/m²       <span class="cm">// 세차 민감도</span>
  ε̄ = <span class="num">23.32°</span>              <span class="cm">// 기준 경사각</span>

<em>전개:</em>
  Q(t) = 475 + 8·(ε(t) - 23.32) - 70·e(t)·sin(ω̃(t))
</pre>

<div class="note">
<b>민감도 해석:</b><br>
• 황도경사각 1° 증가 → 65°N 하지 일사량 <b>+8 W/m²</b> (고위도에 더 많은 직사광)<br>
• 세차 지수 +0.01 → 65°N 하지 일사량 <b>-0.7 W/m²</b> (근일점이 NH 겨울로 이동)<br>
• 현재 총 변동 범위: 약 430~535 W/m² (진폭 ~105 W/m²)
</div>

<!-- ============================================ -->
<h2 id="ch3">3. Layer 2: 대기순환 모델</h2>
<!-- ============================================ -->

<p>지구의 대기순환을 위도·경도·계절의 함수로 계산하는 모델입니다. 핵심 함수는 <code>getWind(lat, lon, dayOfYear, obliquity)</code>이며, 임의의 지점에서의 바람 벡터(u, v)를 반환합니다.</p>

<h3>3-1. 3셀 순환 구조 로직</h3>

<div class="diagram">
고도(km)
  18 ┤                    ┌──<em>상층 반무역풍</em>──┐
     │                    │               │
  12 ┤    <b>극순환</b>          │  <b>해들리순환</b>    │
     │    ↑  ↓          <b>페렐순환</b>          │
   6 ┤    │  │          (간접)           │
     │    ↑  ↓           ↑  ↓            ↓  ← <em>상층 하강</em>
   0 ┤ ←극동풍→  ←편서풍→   ←무역풍→    ↑적도상승↑
     └────┼────┼──────┼────┼──────┼────┼──────┼──
         90°  60°        30°           0°     위도
              <span class="r">극전선</span>      <span class="h">아열대고압</span>       <span class="r">ITCZ</span>
</div>

<h4>알고리즘 흐름</h4>
<pre>
<span class="kw">function</span> <span class="fn">getWind</span>(lat, lon, dayOfYear, obliquity) {

  <span class="cm">// 1단계: 태양 적위 계산</span>
  <span class="kw">const</span> decl = obliquity * sin(2π * (dayOfYear - 80) / 365);

  <span class="cm">// 2단계: ITCZ 위치 결정 (적위의 60%를 따라감)</span>
  <span class="kw">const</span> itcz = decl * <span class="num">0.6</span>;

  <span class="cm">// 3단계: ITCZ 기준 상대 위도 계산</span>
  <span class="kw">const</span> relLat = lat - itcz;
  <span class="kw">const</span> absRelLat = |relLat|;

  <span class="cm">// 4단계: 순환 셀 판별 → 기본 바람 계산</span>
  <span class="kw">if</span> (absRelLat &lt; 30°)  → <em>해들리 셀</em>: 무역풍 (u &lt; 0, v → ITCZ)
  <span class="kw">else if</span> (absRelLat &lt; 60°) → <em>페렐 셀</em>:  편서풍 (u &gt; 0)
  <span class="kw">else</span>                     → <em>극순환 셀</em>: 극동풍 (u &lt; 0)

  <span class="cm">// 5단계: 코리올리 편향 추가</span>
  u += sign(lat) * strength * <span class="num">0.25</span>;

  <span class="cm">// 6단계: 육지 가열 효과 (몬순)</span>
  <span class="kw">if</span> (isLand && summer && 10° &lt; |lat| &lt; 40°)
    v += sign(lat) * <span class="num">2.5</span>;  <span class="cm">// 해양→대륙 유입풍</span>

  <span class="cm">// 7단계: 제트기류 추가 (30° 및 60° 부근)</span>
  u += gaussian(|lat|, 31°, σ=2°) * <span class="num">4</span>;
  u += gaussian(|lat|, 60°, σ=3°) * <span class="num">3</span>;

  <span class="cm">// 8단계: 경도별 미세 변동</span>
  u += sin(lon * π/60) * <span class="num">0.8</span>;

  <span class="kw">return</span> { u, v };
}
</pre>

<h3>3-2. 각 단계의 물리적 근거</h3>
<table>
<tr><th>단계</th><th>물리 원리</th><th>수학 표현</th><th>효과</th></tr>
<tr>
  <td class="val">1. 태양 적위</td>
  <td class="left">지구 자전축 기울기에 의한 태양 직사점 이동</td>
  <td class="val left"><code>δ = ε·sin(2π(d-80)/365)</code></td>
  <td class="left">±23.44° 범위에서 연주 운동</td>
</tr>
<tr>
  <td class="val">2. ITCZ 위치</td>
  <td class="left">열적 적도는 태양 직사점을 따라가되 지연 (~0.6배)</td>
  <td class="val left"><code>ITCZ = 0.6 × δ</code></td>
  <td class="left">약 5°S~15°N 이동 (해양 관성)</td>
</tr>
<tr>
  <td class="val">3. 상대 위도</td>
  <td class="left">순환 셀 경계는 ITCZ를 따라 이동</td>
  <td class="val left"><code>φ' = φ - ITCZ</code></td>
  <td class="left">계절에 따라 풍대가 남북 이동</td>
</tr>
<tr>
  <td class="val">4. 셀 바람</td>
  <td class="left">기압 경도력 + 코리올리력 균형 (지균풍 근사)</td>
  <td class="val left"><code>v = sin(π·φ'/30°)·A</code></td>
  <td class="left">각 셀 내 사인 프로파일 풍속</td>
</tr>
<tr>
  <td class="val">5. 코리올리</td>
  <td class="left">지구 자전에 의한 겉보기 힘 (NH: 우편향, SH: 좌편향)</td>
  <td class="val left"><code>f = 2Ω·sinφ</code></td>
  <td class="left">경도풍 성분 추가</td>
</tr>
<tr>
  <td class="val">6. 몬순</td>
  <td class="left">육지-해양 차등가열 → 열적 저기압 → 유입풍</td>
  <td class="val left"><code>Δv = ±2.5 m/s</code></td>
  <td class="left">여름 대륙 위 무역풍 역전</td>
</tr>
<tr>
  <td class="val">7. 제트기류</td>
  <td class="left">상층 열풍(thermal wind)이 지표까지 영향</td>
  <td class="val left"><code>exp(-((φ-31)²/4))</code></td>
  <td class="left">30°, 60° 부근 서풍 강화</td>
</tr>
</table>

<h3>3-3. ITCZ 동역학과 황도경사각 연동</h3>
<pre>
<span class="cm">// 황도경사각이 ITCZ에 미치는 영향 체인:</span>

<b>ε 증가</b> → δ_max 증가 → ITCZ 이동폭 증가 → 몬순 강화
          ↓
        고위도 여름 일사량 ↑
          ↓
        적도-극 온도차 <span class="kw">감소</span> (고위도 가열)
          ↓
        편서풍 약화, 해들리 셀 확장

<b>ε 감소</b> → δ_max 감소 → ITCZ 이동폭 감소 → 몬순 약화
          ↓
        고위도 여름 일사량 ↓
          ↓
        적도-극 온도차 <span class="kw">증가</span> (고위도 냉각)
          ↓
        편서풍 강화, 해들리 셀 축소
</pre>

<!-- ============================================ -->
<h2 id="ch4">4. Layer 3: 지구 물리 데이터</h2>
<!-- ============================================ -->

<h3>4-1. 대륙 폴리곤 시스템</h3>

<p>17개 대륙/섬 폴리곤을 <code>[경도, 위도]</code> 좌표 배열로 정의합니다. 아프리카, 유럽, 아시아, 북미, 남미, 호주, 남극, 그린란드, 인도, 인도네시아, 일본, 영국, 뉴질랜드, 마다가스카르, 보르네오, 파푸아뉴기니, 중앙아메리카를 포함합니다.</p>

<pre>
<span class="cm">// 예: 아프리카 폴리곤 (20개 꼭짓점)</span>
[[-17,15], [-17,21], [-13,28], [-5,36], [10,37], [11,33],
 [25,32], [33,30], [35,32], [42,13], [51,12], [50,2],
 [42,-2], [40,-11], [35,-26], [28,-34], [18,-35], [15,-28],
 [30,-18], [33,-12], ...]
</pre>

<h3>4-2. 육지 마스크 생성 알고리즘</h3>

<pre>
<span class="cm">// 해상도: 720×360 (0.5° 격자) = 259,200 픽셀</span>
<span class="cm">// 빌드 시 1회 계산 → Uint8Array에 저장 → O(1) 조회</span>

<span class="kw">for each</span> 격자점 (row, col):
  lat = 90 - row × 0.5
  lon = -180 + col × 0.5
  <span class="kw">for each</span> 대륙 폴리곤:
    <span class="kw">if</span> <span class="fn">pointInPolygon</span>(lon, lat, polygon):
      landMask[row × 720 + col] = 1
      <span class="kw">break</span>
</pre>

<h4>Point-in-Polygon 알고리즘 (Ray Casting)</h4>
<pre>
<span class="cm">// 레이 캐스팅: 점에서 오른쪽으로 반직선을 쏘아</span>
<span class="cm">// 폴리곤 변과의 교차 횟수가 홀수면 내부</span>

<span class="kw">function</span> <span class="fn">pointInPolygon</span>(x, y, poly):
  inside = false
  <span class="kw">for</span> 각 변 (i, j):
    <span class="kw">if</span> (yi &gt; y) ≠ (yj &gt; y):        <span class="cm">// 변이 y를 걸치는가?</span>
      xIntersect = (xj-xi)·(y-yi)/(yj-yi) + xi
      <span class="kw">if</span> x &lt; xIntersect:
        inside = !inside              <span class="cm">// 토글</span>
  <span class="kw">return</span> inside

<em>시간복잡도: O(n) per point, n = 꼭짓점 수</em>
<em>전체 마스크 빌드: O(259,200 × 17 × avg_vertices) ≈ ~0.5초</em>
</pre>

<h3>4-3. 바이옴 색상 시스템</h3>
<pre>
<span class="kw">function</span> <span class="fn">getTerrainColor</span>(lat, lon, isLand):

  <span class="kw">if</span> |lat| &gt; 75°     → <span class="cm">빙설 [220,230,240]</span>
  <span class="kw">if</span> !isLand:
    depth = f(lon, lat)  → <span class="cm">심해↔천해 그라데이션</span>
  <span class="kw">if</span> |lat| &gt; 65°     → <span class="cm">툰드라 [180,200,190]</span>
  <span class="kw">if</span> |lat| &gt; 50°     → <span class="cm">북방림 [50,100,40]</span>
  <span class="kw">if</span> |lat| &lt; 10°     → <span class="cm">열대우림 [20,90,20]</span>
  <span class="kw">if</span> |lat| &lt; 30°:
    dryness = f(lon)   → <span class="cm">사막 [160,140,80] or 사바나 [80,130,40]</span>
  <span class="kw">else</span>               → <span class="cm">온대 [34,110,34]</span>
</pre>

<!-- ============================================ -->
<h2 id="ch5">5. Layer 4: 렌더링 엔진</h2>
<!-- ============================================ -->

<h3>5-1. 3D 구면 투영 (Orthographic Projection)</h3>

<h4>정투영 변환 수학</h4>
<pre>
<span class="cm">// 위도경도 → 3D 직교좌표</span>
x = cos(lat) · sin(lon - rotLon)
y = sin(lat)
z = cos(lat) · cos(lon - rotLon)

<span class="cm">// 자전축 기울기 적용 (X축 회전)</span>
y' = y·cos(tilt) - z·sin(tilt)
z' = y·sin(tilt) + z·cos(tilt)

<span class="cm">// 화면 좌표 (z' > 0인 점만 가시)</span>
screenX = cx + x · R
screenY = cy - y' · R
visible = (z' > 0)
</pre>

<h4>역투영 (화면→위경도, 지구본 렌더링용)</h4>
<pre>
<span class="cm">// 각 화면 픽셀에서 위경도를 역산</span>
x  = (screenX - cx) / R
y' = -(screenY - cy) / R
z' = √(1 - x² - y'²)    <span class="cm">// 구면 위의 점 (존재 조건: x²+y'² ≤ 1)</span>

<span class="cm">// 기울기 역변환</span>
y = y'·cos(tilt) + z'·sin(tilt)
z = -y'·sin(tilt) + z'·cos(tilt)

lat = arcsin(y) · 180/π
lon = arctan2(x, z) · 180/π + rotLon
</pre>

<h4>렌더링 파이프라인</h4>
<div class="diagram">
매 프레임:
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  각 픽셀     │───>│ 역투영        │───>│ 색상 결정     │
│  (sx, sy)    │    │ → (lat, lon) │    │ isLand?      │
│  구 내부만   │    │ + 기울기 보정 │    │ biome color  │
└──────────────┘    └──────────────┘    └──────┬───────┘
                                               │
┌──────────────┐    ┌──────────────┐           │
│  ImageData   │<───│ 조명 계산     │<──────────┘
│  에 기록     │    │ Lambert +    │
│  (putImage)  │    │ 대기산란     │
└──────────────┘    └──────────────┘

<em>최적화: GLOBE_RES=2 (2px 단위 계산, 50% 해상도 절약)</em>
</div>

<h3>5-2. 바람 입자 시스템</h3>
<pre>
<span class="cm">// 파티클 풀: 3,000개</span>
<span class="cm">// 각 파티클 속성:</span>
{
  lat, lon,           <span class="cm">// 현재 위치</span>
  prevLat, prevLon,   <span class="cm">// 이전 위치 (궤적 선분용)</span>
  age, maxAge         <span class="cm">// 수명 관리 (60~120 프레임)</span>
}

<span class="cm">// 업데이트 루프 (매 프레임):</span>
<span class="kw">for each</span> particle:
  1. 이전 위치 저장
  2. getWind(lat, lon, day, obliquity) → {u, v}
  3. Δlon = u × dt × 0.15 / cos(lat)   <span class="cm">// 메르카토르 보정</span>
     Δlat = v × dt × 0.15
  4. 위치 업데이트 + 경도 래핑 (-180~180)
  5. age++ → maxAge 초과 시 랜덤 위치로 리셋

<span class="cm">// 렌더링:</span>
  - 지도: prevPos → curPos 선분 (풍속별 색상)
  - 지구본: 3D 투영 후 가시 반구만 그리기
  - 수명 기반 알파 페이드 (등장: 0→1, 퇴장: 1→0)
  - 풍속 색상 매핑: &lt;4m/s 파랑 → 4~7 노랑 → 7~10 주황 → &gt;10 빨강
</pre>

<h3>5-3. 시계열 차트 렌더링</h3>
<pre>
<span class="cm">// 사전 계산: N=2400~3600 데이터 포인트</span>
<span class="cm">// 시간 범위: -500kyr~+100kyr (또는 -800kyr~+100kyr)</span>

<span class="kw">function</span> <span class="fn">drawChart</span>(canvas, data, color, yMin, yMax):
  1. 그리드 라인 + Y축 라벨 (4등분)
  2. X축 라벨 (100kyr 간격)
  3. 간빙기 마커 (MIS 5e, 7, 9, 11, ...) 수직선
  4. 데이터 선 그리기 (Path2D)
  5. 면적 그라데이션 채우기 (color → transparent)
  6. 현재 시점 수직 점선 + 값 표시 점
</pre>

<!-- ============================================ -->
<h2 id="ch6">6. Layer 5: 분석 및 비교 엔진</h2>
<!-- ============================================ -->

<h3>6-1. 분석 흐름</h3>
<div class="diagram">
┌─────────────────────┐
│ <b>궤도 계산 엔진</b>       │  e(t), ε(t), P(t), Q(t)
│ -800kyr ~ +100kyr   │  3,600개 데이터 포인트
└──────────┬──────────┘
           │
     ┌─────┴─────┐
     │           │
     ▼           ▼
┌─────────┐  ┌─────────────┐
│ <b>백분위</b>   │  │ <b>변화율(기울기)</b>│
│ 계산     │  │ 계산         │
│ e: 23%  │  │ de/dt,       │
│ ε: 57%  │  │ dε/dt,       │
│ Q: 42%  │  │ dQ/dt        │
└────┬────┘  └──────┬──────┘
     │              │
     ▼              ▼
┌──────────────────────┐
│ <b>간빙기 비교</b>            │
│ MIS 1 vs 5e,7,9,11,19│
│ (Q, ΔT, 해수면, e)   │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ <b>추세 벡터 종합</b>         │
│ 과거→현재 방향        │
│ 현재 순간 방향        │
│ 자연 미래 방향        │
│ CO₂ 포함 실제 방향    │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│ <b>종합 판단</b>              │
│ "간빙기 하강국면,     │
│  궤도는 냉각 추세,    │
│  CO₂가 역전"          │
└──────────────────────┘
</div>

<h3>6-2. 고기후 데이터 포인트 (참조값)</h3>
<table>
<tr><th>시기</th><th>출처</th><th>CO₂</th><th>ΔT</th><th>해수면</th><th>비고</th></tr>
<tr><td class="val">LGM (21ka)</td><td>EPICA, Vostok</td><td class="val">180</td><td class="val">-5°C</td><td class="val">-120m</td><td class="left">빙하코어 직접 측정</td></tr>
<tr><td class="val">MIS 5e (125ka)</td><td>빙하코어+산호</td><td class="val">285</td><td class="val">+1.5°C</td><td class="val">+6~9m</td><td class="left">마지막 간빙기</td></tr>
<tr><td class="val">MIS 11 (424ka)</td><td>EPICA+ODP</td><td class="val">~280</td><td class="val">+1~2°C</td><td class="val">+6~13m</td><td class="left">현재와 가장 유사한 궤도</td></tr>
<tr><td class="val">홀로세 최적기 (6ka)</td><td>다중 프록시</td><td class="val">265</td><td class="val">+0.5°C</td><td class="val">~0m</td><td class="left">NH 여름 일사 최대</td></tr>
<tr><td class="val">현재 (2024)</td><td>직접 관측</td><td class="val">420</td><td class="val">+1.2°C</td><td class="val">+0.2m</td><td class="left">Mauna Loa, HadCRUT5</td></tr>
</table>

<!-- ============================================ -->
<h2 id="ch7">7. 모듈 간 데이터 흐름</h2>
<!-- ============================================ -->

<h3>7-1. 실시간 시뮬레이션 프레임 루프 (earth-simulation.html)</h3>
<pre>
<span class="fn">requestAnimationFrame</span>(animate)

<span class="kw">function</span> <span class="fn">animate</span>(timestamp):
  dt = timestamp - lastTime      <span class="cm">// 프레임 간격 (ms)</span>

  <span class="cm">// ① 상태 업데이트</span>
  orbitalAngle += dt × orbSpeed  <span class="cm">// 공전 각도</span>
  rotLon += dt × rotSpeed        <span class="cm">// 자전 경도</span>
  dayOfYear = f(orbitalAngle)    <span class="cm">// 궤도각 → 날짜</span>

  <span class="cm">// ② 바람 입자 업데이트</span>
  <span class="kw">for each</span> particle:
    wind = <span class="fn">getWind</span>(p.lat, p.lon, dayOfYear, obliquity)
    p.lon += wind.u × dt
    p.lat += wind.v × dt

  <span class="cm">// ③ 렌더링 (3개 캔버스 동시)</span>
  <span class="fn">renderOrbital</span>(ctx1, orbitalAngle, ecc, obliquity)
  <span class="fn">renderGlobe</span>(ctx2, rotLon, obliquity, dayOfYear)
  <span class="fn">renderMap</span>(ctx3, dayOfYear, obliquity)

  <span class="cm">// ④ UI 업데이트</span>
  displayValues(dayOfYear, obliquity, ecc, wind)
</pre>

<h3>7-2. 전체 데이터 의존성 그래프</h3>
<div class="diagram">
<span class="h">시간 t (kyr)</span>
  │
  ├──→ <b>calcEcc(t)</b> ─────→ e(t) ──┬──→ 궤도 시각화
  │                              ├──→ calcPrec(t)에 곱해짐
  │                              └──→ 일사량 비대칭 결정
  │
  ├──→ <b>calcObl(t)</b> ─────→ ε(t) ──┬──→ 자전축 기울기 시각화
  │                              ├──→ 태양 적위 결정
  │                              ├──→ ITCZ 이동 범위 결정
  │                              └──→ 65°N 일사량에 +8 W/m²/°
  │
  ├──→ <b>calcPrec(t)</b> ────→ P(t) ──┬──→ 세차 차트
  │    (e(t) × sin(ω))          └──→ 65°N 일사량에 -70 W/m²·P
  │
  └──→ <b>calcInsol(t)</b> ───→ Q(t) ──┬──→ 일사량 차트
       (ε, P의 함수)              └──→ 기온 프록시 입력

<span class="h">날짜 d (일)</span>
  │
  ├──→ <b>태양적위</b> δ = ε·sin(2π(d-80)/365)
  │     │
  │     └──→ <b>ITCZ 위치</b> = 0.6 × δ
  │           │
  │           └──→ <b>getWind(lat,lon,d,ε)</b>
  │                 │
  │                 ├──→ 셀 판별 (해들리/페렐/극)
  │                 ├──→ <b>isLand(lat,lon)</b> ──→ 몬순 보정
  │                 └──→ {u, v} 바람 벡터
  │                       │
  │                       └──→ 입자 이동
  │                            │
  │                            └──→ 렌더링 (지도 + 지구본)
  │
  └──→ <b>조명 방향</b> = f(d) ──→ 지구본 셰이딩
</div>

<!-- ============================================ -->
<h2 id="ch8">8. 핵심 알고리즘 상세 해설</h2>
<!-- ============================================ -->

<h3>8-1. 구면 위 바람 입자 이동의 메르카토르 보정</h3>
<pre>
<span class="cm">// 문제: 위도가 높아질수록 경선 간 실제 거리가 줄어듦</span>
<span class="cm">// cos(60°) = 0.5 → 경도 1°의 실거리가 적도의 절반</span>
<span class="cm">// 보정 없이 동일한 Δlon을 적용하면 고위도에서 비정상적 가속</span>

Δlon = u × dt / <span class="fn">max</span>(cos(lat × π/180), <span class="num">0.1</span>)
<span class="cm">                                         ↑ 극점 발산 방지</span>
Δlat = v × dt
<span class="cm">// 이 보정으로 고위도에서의 동서 이동이 실제 거리에 비례</span>
</pre>

<h3>8-2. 지구본의 조명 모델</h3>
<pre>
<span class="cm">// Lambert 반사 모델 (확산 반사)</span>

<span class="cm">// 태양 방향 벡터 (계절에 따라 변화)</span>
sunDir = normalize(sin(seasonAngle)×0.3, -0.2, 1.0)

<span class="cm">// 각 표면점의 법선 벡터 = (x, -y', z') (구면이므로 위치=법선)</span>
light = dot(normal, sunDir) = nx·sx + ny·sy + nz·sz

<span class="cm">// 최소 조도 보장 (암부도 완전히 검지 않게)</span>
light = max(0.15, light)

<span class="cm">// 대기 산란 효과 (가장자리에서 파란 빛)</span>
edge = 1 - distance_from_center / R
atmosphere = (1 - edge)³ × 0.4
finalColor.b += atmosphere × 180
</pre>

<h3>8-3. 기온 프록시 추정 (trend-analysis.html)</h3>
<pre>
<span class="cm">// 빙하코어 δ¹⁸O와 유사한 패턴을 만들기 위한 간략 모델</span>
<span class="cm">// 핵심: 일사량의 시간 적분 (빙하 볼륨은 일사량 적분에 비례)</span>

<span class="kw">function</span> <span class="fn">calcTemp</span>(tKyr):
  Q = calcInsol(tKyr)

  <span class="cm">// 빙하 볼륨 프록시: 과거 8kyr 일사량 부족분의 적분</span>
  ice = Σ(t-8 to t) [475 - calcInsol(τ)] × 0.12

  <span class="cm">// 기온 = 일사량 직접효과 + 빙하 피드백 + 경사각 효과</span>
  T = (Q - 475) × 0.05      <span class="cm">// 일사량 직접</span>
    - ice × 0.3              <span class="cm">// 빙하-알베도 양의 피드백</span>
    + (ε - 23.3) × 0.4       <span class="cm">// 경사각 고위도 효과</span>
</pre>

<div class="note">
<b>이 모델의 물리적 의미:</b><br>
1. <b>일사량 직접 효과 (×0.05)</b>: 일사량 1 W/m² 변화 → ~0.05°C 즉시 반응<br>
2. <b>빙하 피드백 (×0.3)</b>: 일사량 부족이 누적되면 빙하 성장 → 알베도 증가 → 추가 냉각 (양의 피드백, ~8kyr 시상수)<br>
3. <b>경사각 효과 (×0.4)</b>: 경사각 1° 변화 → ~0.4°C (고위도 직접 가열/냉각)
</div>

<!-- ============================================ -->
<h2 id="ch9">9. 과학적 근거 및 한계</h2>
<!-- ============================================ -->

<h3>9-1. 사용된 과학적 모델의 근거</h3>
<table>
<tr><th>모델</th><th>기반 이론</th><th>원논문</th><th>정확도</th></tr>
<tr>
  <td class="left val">궤도 요소 계산</td>
  <td class="left">행성 섭동의 해석적 풀이</td>
  <td class="left">Berger (1978), Berger & Loutre (1991)</td>
  <td class="left">±1 Myr 이내에서 수 % 이내 정확</td>
</tr>
<tr>
  <td class="left val">일사량 계산</td>
  <td class="left">구면 기하학 + 케플러 법칙</td>
  <td class="left">Milankovitch (1941), Berger (1978)</td>
  <td class="left">선형 근사, ±5 W/m² 이내</td>
</tr>
<tr>
  <td class="left val">3셀 대기순환</td>
  <td class="left">대기역학 표준 모델</td>
  <td class="left">Holton (2004), Hartmann (1994)</td>
  <td class="left">정성적으로 정확, 정량적 단순화</td>
</tr>
<tr>
  <td class="left val">기온 프록시</td>
  <td class="left">일사량-빙하 피드백 모델</td>
  <td class="left">Imbrie & Imbrie (1980)</td>
  <td class="left">~100kyr 패턴 재현, 진폭 근사</td>
</tr>
</table>

<h3>9-2. 이 시뮬레이션의 한계</h3>
<div class="grid2">
<div class="card">
<h4 style="color:#ff8866">단순화된 부분</h4>
<p><b>궤도:</b> Berger의 26항 전체가 아닌 5~6항만 사용 → 세부 구조 생략</p>
<p><b>대기순환:</b> 3셀 정상상태 가정 → 실제의 에디·로즈비파·폭풍 등 비정상 현상 미포함</p>
<p><b>지형:</b> 폴리곤 근사 → 해안선 해상도 ~2~5° 수준</p>
<p><b>해양순환:</b> 미포함 (열염분 순환, ENSO 등)</p>
<p><b>빙상 역학:</b> 미포함 (빙하 흐름, 칼빙 등)</p>
<p><b>구름·수증기:</b> 미포함 (복사 피드백)</p>
</div>
<div class="card">
<h4 style="color:#66bbff">신뢰할 수 있는 부분</h4>
<p><b>궤도 주기:</b> 41kyr, 100kyr, 413kyr, 23kyr 주기와 위상은 정확</p>
<p><b>현재 값:</b> e=0.0167, ε=23.44°, Q≈474 W/m²는 관측값과 일치</p>
<p><b>풍대 구조:</b> 무역풍·편서풍·극동풍의 위도별 분포는 관측과 일치</p>
<p><b>ITCZ 이동:</b> 5°S~15°N 범위와 계절 패턴은 위성 관측과 부합</p>
<p><b>추세 방향:</b> 모든 궤도 요소의 변화 방향과 크기는 정확</p>
<p><b>간빙기 비교:</b> MIS 11 유사성 등의 판단은 학계 합의와 일치</p>
</div>
</div>

<h3>9-3. 더 정밀한 시뮬레이션을 위해 필요한 것</h3>
<table>
<tr><th>개선 항목</th><th>필요 기술</th><th>효과</th></tr>
<tr><td class="left">전체 Berger 급수 (26항+)</td><td class="left">더 많은 푸리에 계수</td><td class="left">수만 년 스케일 세부구조</td></tr>
<tr><td class="left">GCM 수준 대기순환</td><td class="left">Navier-Stokes PDE 풀기 (GPU)</td><td class="left">실제적 기상 패턴</td></tr>
<tr><td class="left">해양 순환</td><td class="left">3D 해양 모델 결합</td><td class="left">ENSO, AMOC, 열수송</td></tr>
<tr><td class="left">탄소 순환</td><td class="left">생지화학 모델</td><td class="left">CO₂ 피드백 자기일관적 계산</td></tr>
<tr><td class="left">빙상 모델</td><td class="left">유체역학 빙상 모델</td><td class="left">빙하기 진입/탈출 시뮬레이션</td></tr>
<tr><td class="left">고해상도 지형</td><td class="left">ETOPO1 데이터 (1분 해상도)</td><td class="left">실제적 지형 렌더링</td></tr>
</table>

<br>
<div class="note" style="text-align:center">
  <a href="index.html">← 프로젝트 인덱스로 돌아가기</a>
</div>

<footer style="text-align:center;padding:10px;color:#3a4a6a;font-size:.8em;border-top:1px solid #1a2a4a;">
  전체 로직 설명서 — Earth Simulation Project
<br>Built with <a href="https://claude.ai/claude-code" style="color:#5af;text-decoration:none">Claude Code</a> (Anthropic Claude Opus 4.6)
</footer>

</div><!-- container -->
</body>
</html>
